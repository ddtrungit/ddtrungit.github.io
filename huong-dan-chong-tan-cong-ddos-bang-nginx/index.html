<!DOCTYPE html><html lang="vi"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Hướng dẫn chống tấn công DDoS bằng Nginx - TRUNG DUONG</title><meta name="robots" content="noindex,nofollow"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="alternate" type="application/atom+xml" href="https://ddtrungit.github.io/feed.xml"><link rel="alternate" type="application/json" href="https://ddtrungit.github.io/feed.json"><link rel="stylesheet" href="https://ddtrungit.github.io/assets/css/style.css?v=6ddec22a33b6e591633ba53617c15038"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://ddtrungit.github.io/huong-dan-chong-tan-cong-ddos-bang-nginx/index.html"},"headline":"Hướng dẫn chống tấn công DDoS bằng Nginx","datePublished":"2021-01-28T04:05","dateModified":"2022-06-13T14:29","image":{"@type":"ImageObject","url":"https://ddtrungit.github.io/media/posts/88/tai-xuong-1-1.png","height":153,"width":330},"description":"Các điểm bất thường trong log: Có thể kết luận: Việc cần làm tiếp theo là chặn các truy cập&hellip;","author":{"@type":"Person","name":"Duong Dinh Trung","url":"https://ddtrungit.github.io/authors/dtrungit/"},"publisher":{"@type":"Organization","name":"Duong Dinh Trung","logo":{"@type":"ImageObject","url":"https://ddtrungit.github.io/media/website/Background_2.png","height":800,"width":834}}}</script></head><body><header class="header" id="js-header"><a href="https://ddtrungit.github.io/index.html" class="logo"><img src="https://ddtrungit.github.io/media/website/Background_2.png" alt="TRUNG DUONG"></a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://ddtrungit.github.io/index.html" target="_self">Home</a></li><li><a href="https://ddtrungit.github.io/gioi-thieu/index.html" target="_self">About</a></li><li><a href="https://ddtrungit.github.io/tags/ansible/index.html" target="_self">Ansible</a></li><li><a href="https://ddtrungit.github.io/tags/aws/index.html" target="_self">AWS</a></li><li><a href="https://ddtrungit.github.io/tags/oracle/index.html" target="_self">Oracle</a></li><li><a href="https://ddtrungit.github.io/tags/linux/index.html" target="_self">Linux</a></li><li><a href="https://ddtrungit.github.io/tags/zimbra/index.html" target="_self">Zimbra</a></li><li><a href="https://ddtrungit.github.io/tags/tip/index.html" target="_self">TIP</a></li></ul></nav></header><main><div class="wrapper"><article class="post"><header class="post__header"><a href="https://ddtrungit.github.io/tags/linux/index.html" class="post__maintag">Linux</a><h1 class="post__title">Hướng dẫn chống tấn công DDoS bằng Nginx</h1><div class="post__meta"><div class="post__author">By <a href="https://ddtrungit.github.io/authors/dtrungit/index.html" class="invert" rel="author" title="Duong Dinh Trung">Duong Dinh Trung</a></div></div></header><figure class="post__featured-image"><img src="https://ddtrungit.github.io/media/posts/88/tai-xuong-1-1.png" srcset="https://ddtrungit.github.io/media/posts/88/responsive/tai-xuong-1-1-xs.png 300w, https://ddtrungit.github.io/media/posts/88/responsive/tai-xuong-1-1-sm.png 480w, https://ddtrungit.github.io/media/posts/88/responsive/tai-xuong-1-1-md.png 768w, https://ddtrungit.github.io/media/posts/88/responsive/tai-xuong-1-1-lg.png 1200w" sizes="(min-width: 56.25em) 100vw, (min-width: 37.5em) 50vw, 100vw" loading="eager" height="153" width="330" alt=""></figure><div class="post__inner"><div class="post__entry"><p></p><h2>PHÂN TÍCH LOG TẤN CÔNG DDoS</h2><p></p><p></p><figure class="wp-block-image"><figure class="wp-image-360"><img loading="lazy" src="https://ddtrungit.github.io/media/posts/88/oom_3-1-1024x513.png" sizes="(max-width: 48em) 100vw, 100vw" srcset="https://ddtrungit.github.io/media/posts/88/responsive/oom_3-1-1024x513-xs.png 300w, https://ddtrungit.github.io/media/posts/88/responsive/oom_3-1-1024x513-sm.png 480w, https://ddtrungit.github.io/media/posts/88/responsive/oom_3-1-1024x513-md.png 768w" alt="log tấn công ddos"></figure></figure><p></p><p></p><p>Các điểm bất thường trong log:</p><p></p><p></p><ul><li>Các truy cập vào chung 1 URL có pattern là “<em>/?add_to_wishlist=xxxx</em>“</li><li>Truy cập xuất phát từ nhiều IP khác nhau nhưng lại chung 1 User-Agent</li><li>Cùng sử dụng HTTP/1.0</li><li>Các IP trên khi truy cập URL KHÔNG load kèm theo các static resources như css, js</li></ul><p></p><p></p><p>Có thể kết luận:</p><p></p><p></p><ul><li>Các truy cập trên được sinh ra từ cùng 1 công cụ tự động, được cài đặt ở nhiều máy tính khác nhau.</li><li>Các truy cập trên không phải của người dùng hợp lệ và không sử dụng browser để truy cập (do sử dụng HTTP/1.0 và không load các static resource kèm theo)</li><li>Đây là kiểu tấn công DDoS bằng botnet</li></ul><p></p><p></p><h2>CHỐNG TẤN CÔNG DDoS bằng Nginx</h2><p></p><p></p><p>Việc cần làm tiếp theo là chặn các truy cập không hợp lệ mang các đặc điểm trên. Để giảm thiểu tối đa ảnh hưởng đến người dùng hợp lệ khác, ta cần tạo ra một chữ ký nhận diện sao cho càng sát với đặc điểm của botnet càng tốt. Tôi chọn chữ ký bao gồm TẤT CẢ các đặc điểm sau:</p><p></p><p></p><ul><li>1. Truy cập vào đúng URL /</li><li>2. Request có argument là  <em>“add_to_wishlist”</em> và theo sau đó là 1 dãy số.</li><li>3. Sử dụng User-Agent: <em>Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.143 Safari/537.36</em></li><li>4. Sử dụng <em>HTTP/1.0</em></li><li>5. Sử dụng method: <em>GET</em></li></ul><p></p><p></p><p>Ta cần viết rule chặn các điều kiện riêng lẻ trước, đảm bảo chúng hoạt động đúng trước khi kết hợp toàn bộ lại với nhau. Hiện tại website đang sử dụng mô hình <a href="https://blog.vietnix.vn/zero2hero-4-gioi-thieu-ve-lamp-lemp-reverse-proxy-mo-hinh-he-thong-web.html">Reverse Proxy</a> nên tôi sẽ tiến hành cấu hình chống tấn cống DDoS trên Nginx</p><p></p><p></p><h3>1. Truy cập vào đúng URL /</h3><p></p><p></p><p>Để chỉ áp dụng filter lên riêng các truy cập chính xác đến URL /, ta khai báo location sử dụng exact match (dấu <em>“=”</em>):</p><p></p><p></p><pre class="wp-block-code"><code>location = / { ...}</code></pre><p></p><p></p><p>Các điều kiện số 2-5 sẽ được config bên trong location này.</p><p></p><p></p><h3>2. Request có argument là  “add_to_wishlist” và theo sau là 1 dãy số</h3><p></p><p></p><p>Để kiểm tra argument <em>“add_to_wishlist”</em> có tồn tại hay không, và theo sau có phải là 1 dãy số, ta sử dụng regular expression như sau:</p><p></p><p></p><pre class="wp-block-code"><code>if ($arg_add_to_wishlist ~ "[0-9]+") {    return 406;}</code></pre><p></p><p></p><p>Kiểm tra thử và đảm bảo điều kiện trên hoạt động đúng: Điều chỉnh file config virtualhost của website, thêm vào như sau:</p><p></p><p></p><pre class="wp-block-code"><code>location = / {     if ($arg_add_to_wishlist ~ "[0-9]+") {        return 406;    }}</code></pre><p></p><p></p><p>Dùng curl để kiểm tra, nếu filter hoạt động đúng sẽ trả về status code là 406 với các request dạng <em>“/?add_to_wishlis=xxxx”</em>, với các request khác thì status code vẫn là 200 như bình thường:</p><p></p><p></p><pre class="wp-block-code"><code># Request tấn công, sẽ trả vể status code 406[zero2hero@vietnix.vn ~]$ curl 'https://blog.vietnix.vn/?add_to_wishlist=123' -IHTTP/1.1 406 Not AcceptableServer: nginx/1.16.1Date: Wed, 29 Apr 2020 03:39:28 GMTContent-Type: text/htmlContent-Length: 163Connection: keep-alive# Request bình thường khác, trả về status code 200[zero2hero@vietnix.vn ~]$ curl 'https://blog.vietnix.vn/' -IHTTP/1.1 200 OKServer: nginx/1.16.1Date: Wed, 29 Apr 2020 04:48:53 GMTContent-Type: text/htmlContent-Length: 4833Last-Modified: Fri, 16 May 2014 15:12:48 GMTConnection: keep-aliveETag: "53762af0-12e1"Accept-Ranges: bytes</code></pre><p></p><p></p><h3>3. Request sử dụng User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.143 Safari/537.36</h3><p></p><p></p><p>Để kiểm tra User-Agent ta sử dụng biến <em>$http_user_agent</em>. Điều chỉnh file config Virtual Host, thêm vào như sau:</p><p></p><p></p><pre class="wp-block-code"><code>location = / {    if ($http_user_agent = "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.143 Safari/537.36") {	    return 406;    }}</code></pre><p></p><p></p><p>Dùng curl kiểm tra lại:</p><p></p><p></p><ul><li>Nếu request sử dụng User-Agent “Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.143 Safari/537.36” sẽ trả về status code 406.</li><li>Các User-Agent khác trả về status code 200 như bình thường</li></ul><p></p><p></p><pre class="wp-block-code"><code># Request sử dụng User-Agent phải trả về 406[zero2hero@vietnix.vn ~]$ curl 'https://blog.vietnix.vn/' -I -H "User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.143 Safari/537.36"HTTP/1.1 406 Not AcceptableServer: nginx/1.16.1Date: Wed, 29 Apr 2020 03:46:05 GMTContent-Type: text/htmlContent-Length: 565Connection: keep-alive# Request sử dụng User-Agent khác: trả về 200[zero2hero@vietnix.vn ~]$ curl 'https://blog.vietnix.vn/' -I -H "User-Agent: Iphone"HTTP/1.1 200 OKServer: nginx/1.16.1Date: Wed, 29 Apr 2020 03:51:31 GMTContent-Type: text/htmlContent-Length: 4833Last-Modified: Fri, 16 May 2014 15:12:48 GMTConnection: keep-aliveETag: "53762af0-12e1"Accept-Ranges: bytes</code></pre><p></p><p></p><p>Đã hoạt động chính xác như mong muốn.</p><p></p><p></p><h3>4. Request sử dụng HTTP1/0:</h3><p></p><p></p><p>Để kiểm tra version HTTP, ta sử dụng biến <em>“$server_protocol”</em>. Điều chỉnh file config Virtual Host và thêm vào như sau:</p><p></p><p></p><pre class="wp-block-code"><code>location = / {     if ($server_protocol = "HTTP/1.0") {    	return 406;    }}</code></pre><p></p><p></p><p>Kiểm tra, nếu request sử dụng HTTP/1.0 thì trả về status code 406, ngược lại trả về status code 200 như bình thường:</p><p></p><p></p><pre class="wp-block-code"><code># Request sử dụng HTTP/1.0: trả về 406[zero2hero@vietnix.vn ~]$ curl 'https://blog.vietnix.vn/' -I --http1.0HTTP/1.1 406 Not AcceptableServer: nginx/1.16.1Date: Wed, 29 Apr 2020 03:52:12 GMTContent-Type: text/htmlContent-Length: 163Connection: close# Reques sử dụng HTTP/1.1: trả về 200[zero2hero@vietnix.vn ~]$ curl 'https://blog.vietnix.vn/' -I --http1.1HTTP/1.1 200 OKServer: nginx/1.16.1Date: Wed, 29 Apr 2020 04:57:35 GMTContent-Type: text/htmlContent-Length: 4833Last-Modified: Fri, 16 May 2014 15:12:48 GMTConnection: keep-aliveETag: "53762af0-12e1"Accept-Ranges: bytes</code></pre><p></p><p></p><p>Đã hoạt động đúng như mong muốn.</p><p></p><p></p><h3>5. Sử dụng method: GET</h3><p></p><p></p><p>Để kiểm tra request method, ta sử dụng biến<em> “$request_method”</em>, điều chỉnh file config thêm vào dòng sau:</p><p></p><p></p><pre class="wp-block-code"><code>location = / {     if ($request_method = "GET") {    	return 406;    }}</code></pre><p></p><p></p><h3>6. Tổng hợp tất cả các điều kiện</h3><p></p><p></p><p>Các điều kiện riêng lẻ đã được kiểm tra và đảm bảo hoạt động đúng như mong muốn, ta cần kết hợp các điều kiện lại với nhau sao cho khi request chứa TẤT CẢ các đặc điểm trên sẽ bị DROP. </p><p></p><p></p><p>Tuy nhiên, nginx không hỗ trợ toán tử AND để giúp ta AND các điều kiện lại với nhau, ta cần sử dụng trick như sau:</p><p></p><p></p><ul><li>Khai báo một biến $BLOCK với giá trị rỗng.</li><li>Mỗi điều kiện match sẽ Append một giá trị vào biến $BLOCK</li><li>Nếu kết quả cuối cùng của biến $BLOCK chứa đầy đủ các giá trị mong muốn thì DROP request đấy.</li></ul><p></p><p></p><p>Cụ thể:</p><p></p><p></p><pre class="wp-block-code"><code>   location = / {                set $BLOCK "";                if ($arg_add_to_wishlist ~ "[0-9]+") {                        set $BLOCK "${BLOCK}T";                }                if ($http_user_agent = "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.143 Safari/537.36") {                        set $BLOCK "${BLOCK}R";                }                if ($server_protocol = "HTTP/1.0") {                        set $BLOCK "${BLOCK}U";                }                if ($request_method = "GET") {                        set $BLOCK "${BLOCK}E";                }                if ($BLOCK = "TRUE") {                        return 444;                }                [...]        }</code></pre><p></p><p></p><p>Kiểm tra lại: </p><p></p><p></p><pre class="wp-block-code"><code>[zero2hero@vietnix.vn ~]$ curl 'https://blog.vietnix.vn/?add_to_wishlist=123' -H "User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.143 Safari/537.36" --http1.0curl: (52) Empty reply from server</code></pre><p></p><p></p><p>Khi sử dụng return 444, kết quả nhận được khi curl sẽ là <em>“curl: (52) Empty reply from server”</em>, kết quả hoàn toàn đúng như ta mong đợi.</p><p></p></div><footer><div class="post__tags-share"><aside class="post__share"></aside></div></footer></div></article></div><div class="post__related"><div class="wrapper"><h2 class="h5">Related posts</h2><div class="l-grid l-grid--4"><article class="c-card"><a href="https://ddtrungit.github.io/install-nginx-on-amazon-linux-2/index.html" class="c-card__image"><img src="https://ddtrungit.github.io/media/posts/103/tai-xuong-1-1.png" srcset="https://ddtrungit.github.io/media/posts/103/responsive/tai-xuong-1-1-xs.png 300w, https://ddtrungit.github.io/media/posts/103/responsive/tai-xuong-1-1-sm.png 480w, https://ddtrungit.github.io/media/posts/103/responsive/tai-xuong-1-1-md.png 768w, https://ddtrungit.github.io/media/posts/103/responsive/tai-xuong-1-1-lg.png 1200w" sizes="(min-width: 56.25em) 100vw, (min-width: 37.5em) 50vw, 100vw" loading="lazy" height="153" width="330" alt=""></a><div class="c-card__wrapper"><header class="c-card__header"><div class="c-card__tag"><a href="https://ddtrungit.github.io/tags/aws/index.html">Aws</a></div><h3 class="c-card__title"><a href="https://ddtrungit.github.io/install-nginx-on-amazon-linux-2/index.html" class="invert">Install Nginx on Amazon Linux 2</a></h3></header></div></article><article class="c-card"><a href="https://ddtrungit.github.io/huong-dan-debug-bang-strace-url-wordpress/index.html" class="c-card__image"><img src="https://ddtrungit.github.io/media/posts/89/best-ways-to-speed-up-wp-site.jpg" srcset="https://ddtrungit.github.io/media/posts/89/responsive/best-ways-to-speed-up-wp-site-xs.jpg 300w, https://ddtrungit.github.io/media/posts/89/responsive/best-ways-to-speed-up-wp-site-sm.jpg 480w, https://ddtrungit.github.io/media/posts/89/responsive/best-ways-to-speed-up-wp-site-md.jpg 768w, https://ddtrungit.github.io/media/posts/89/responsive/best-ways-to-speed-up-wp-site-lg.jpg 1200w" sizes="(min-width: 56.25em) 100vw, (min-width: 37.5em) 50vw, 100vw" loading="lazy" height="1080" width="1920" alt=""></a><div class="c-card__wrapper"><header class="c-card__header"><div class="c-card__tag"><a href="https://ddtrungit.github.io/tags/tip/index.html">Tip</a></div><h3 class="c-card__title"><a href="https://ddtrungit.github.io/huong-dan-debug-bang-strace-url-wordpress/index.html" class="invert">Hướng dẫn debug bằng strace URL WordPress</a></h3></header></div></article><article class="c-card"><a href="https://ddtrungit.github.io/liet-ke-danh-sach-process-su-dung-nhieu-ram-nhat-bang-tophtop/index.html" class="c-card__image"><img src="https://ddtrungit.github.io/media/posts/84/676029069_1280x720.jpg" srcset="https://ddtrungit.github.io/media/posts/84/responsive/676029069_1280x720-xs.jpg 300w, https://ddtrungit.github.io/media/posts/84/responsive/676029069_1280x720-sm.jpg 480w, https://ddtrungit.github.io/media/posts/84/responsive/676029069_1280x720-md.jpg 768w, https://ddtrungit.github.io/media/posts/84/responsive/676029069_1280x720-lg.jpg 1200w" sizes="(min-width: 56.25em) 100vw, (min-width: 37.5em) 50vw, 100vw" loading="lazy" height="720" width="1280" alt=""></a><div class="c-card__wrapper"><header class="c-card__header"><div class="c-card__tag"><a href="https://ddtrungit.github.io/tags/linux/index.html">Linux</a></div><h3 class="c-card__title"><a href="https://ddtrungit.github.io/liet-ke-danh-sach-process-su-dung-nhieu-ram-nhat-bang-tophtop/index.html" class="invert">Liệt kê danh sách Process sử dụng nhiều RAM nhất bằng top/htop</a></h3></header></div></article></div></div></div></main><footer class="footer"><div class="footer__social"><a href="https://facebook.com/duongtrung2103" aria-label="Facebook" class="facebook"><svg><use xlink:href="https://ddtrungit.github.io/assets/svg/svg-map.svg#facebook"/></svg></a></div><div class="footer__copyright">"DO THE THINGS YOU LOVE!"</div></footer><script>window.publiiThemeMenuConfig = {    
      mobileMenuMode: 'sidebar',
      animationSpeed: 300,
      submenuWidth: 'auto',
      doubleClickTime: 500,
      mobileMenuExpandableSubmenus: true, 
      relatedContainerForOverlayMenuSelector: '.navbar',
   };</script><script defer="defer" src="https://ddtrungit.github.io/assets/js/scripts.min.js?v=d78591855e0ce96bf51239b499260e20"></script><script>var images = document.querySelectorAll('img[loading]');

      for (var i = 0; i < images.length; i++) {
         if (images[i].complete) {
               images[i].classList.add('is-loaded');
         } else {
               images[i].addEventListener('load', function () {
                  this.classList.add('is-loaded');
               }, false);
         }
      }</script></body></html>