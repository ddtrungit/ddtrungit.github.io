<!DOCTYPE html><html lang="vi"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Các bước rebuild Zimbra server (NG Backup) - TRUNG DUONG</title><meta name="robots" content="noindex,nofollow"><meta name="generator" content="Publii Open-Source CMS for Static Site"><meta name="theme-color" content="#17181E" media="(prefers-color-scheme: dark)"><meta name="theme-color" content="#D73A42" media="(prefers-color-scheme: light)"><meta name="msapplication-navbutton-color" content="#D73A42"><meta name="apple-mobile-web-app-status-bar-style" content="#D73A42"><link rel="alternate" type="application/atom+xml" href="https://ddtrungit.github.io/feed.xml"><link rel="alternate" type="application/json" href="https://ddtrungit.github.io/feed.json"><link rel="shortcut icon" href="https://ddtrungit.github.io/media/website/cropped-2019-09-16-32x32.png" type="image/x-icon"><link rel="shortcut icon" href="https://ddtrungit.github.io/media/website/cropped-2019-09-16-32x32.png" type="image/x-icon"><link rel="stylesheet" href="https://ddtrungit.github.io/assets/css/style.css?v=4becd99c93342dd7c117b97188f052e6"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://ddtrungit.github.io/cac-buoc-rebuild-zimbra-server-ng-backup/index.html"},"headline":"Các bước rebuild Zimbra server (NG Backup)","datePublished":"2021-01-27T08:27","dateModified":"2022-06-13T14:33","image":{"@type":"ImageObject","url":"https://ddtrungit.github.io/media/posts/80/tai-xuong.png","height":157,"width":320},"description":"Có nhiều phương pháp để xây dựng lại server mới thay thế cho server cũ đã bị hack. Một trong&hellip;","author":{"@type":"Person","name":"Duong Dinh Trung","url":"https://ddtrungit.github.io/authors/dtrungit/"},"publisher":{"@type":"Organization","name":"Duong Dinh Trung","logo":{"@type":"ImageObject","url":"https://ddtrungit.github.io/media/website/Background_2.png","height":800,"width":834}}}</script></head><body><header class="header" id="js-header"><a href="https://ddtrungit.github.io/index.html" class="logo"><img src="https://ddtrungit.github.io/media/website/Background_2.png" alt="TRUNG DUONG"></a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://ddtrungit.github.io/index.html" target="_self">Home</a></li><li><a href="https://ddtrungit.github.io/lien-he/index.html" target="_self">Contact</a></li><li><a href="https://ddtrungit.github.io/gioi-thieu/index.html" target="_self">About</a></li><li><a href="https://ddtrungit.github.io/tags/ansible/index.html" target="_self">Ansible</a></li><li><a href="https://ddtrungit.github.io/tags/aws/index.html" target="_self">AWS</a></li><li><a href="https://ddtrungit.github.io/tags/oracle/index.html" target="_self">Oracle</a></li><li><a href="https://ddtrungit.github.io/tags/linux/index.html" target="_self">Linux</a></li><li><a href="https://ddtrungit.github.io/tags/zimbra/index.html" target="_self">Zimbra</a></li><li><a href="https://ddtrungit.github.io/tags/tip/index.html" target="_self">TIP</a></li><li><a href="https://ddtrungit.github.io/tags/k8s/index.html" target="_self">Kubernetes</a></li></ul></nav></header><main><div class="wrapper"><article class="post"><header class="post__header"><h1 class="post__title">Các bước rebuild Zimbra server (NG Backup)</h1><div class="post__meta"><div class="post__author">By <a href="https://ddtrungit.github.io/authors/dtrungit/index.html" class="invert" rel="author" title="Duong Dinh Trung">Duong Dinh Trung</a></div><div class="post__comments"><a href="https://ddtrungit.github.io/cac-buoc-rebuild-zimbra-server-ng-backup/index.html#comments" rel="nofollow" aria-label="Comments"><svg aria-hidden="true"><title>Comments</title><use xlink:href="https://ddtrungit.github.io/assets/svg/svg-map.svg#comments"/></svg></a></div></div></header><figure class="post__featured-image"><img src="https://ddtrungit.github.io/media/posts/80/tai-xuong.png" srcset="https://ddtrungit.github.io/media/posts/80/responsive/tai-xuong-xs.png 300w, https://ddtrungit.github.io/media/posts/80/responsive/tai-xuong-sm.png 480w, https://ddtrungit.github.io/media/posts/80/responsive/tai-xuong-md.png 768w, https://ddtrungit.github.io/media/posts/80/responsive/tai-xuong-lg.png 1200w" sizes="(min-width: 56.25em) 100vw, (min-width: 37.5em) 50vw, 100vw" loading="eager" height="157" width="320" alt=""></figure><div class="post__inner"><div class="post__entry"><p></p><p>Có nhiều phương pháp để xây dựng lại server mới thay thế cho server cũ đã bị hack. Một trong những phương pháp thường được sử dụng  là Zimlet Zextras-Suite hoặc NG Backup. Bạn cũng có thể sử dụng imapsync hoặc rsync để di chuyển dữ liệu mailbox từ server cũ sang server mới. Trong bài viết này, chúng tôi sẽ hướng dẫn cách sử dụng Zextras-Suite/NG Backup.</p><p></p><p></p><p>Cách này sử dụng bản dùng thử của Zextras-Suite để export và import dữ liệu. Bản dùng thử này có thời hạn 1 tháng. Như vậy cách này nên áp dụng cho các server mà bạn chưa cài Zextras-Suite/NG Backup bao giờ. Chúng tôi giả định bạn đang sử dụng môi trường ảo hóa.</p><p></p><p></p><p><strong>Các bước thực hiện trên server cũ:</strong></p><p></p><p></p><p><strong>1. Download và cài đặt Zextras-Suite:</strong></p><p></p><p></p><p>[Chạy với quyền root]</p><p></p><p></p><p><em>wget </em><a href="http://download.zextras.com/zextras_suite-legacy.tgz"><em>http://download.zextras.com/zextras_suite-legacy.tgz</em></a></p><p></p><p></p><p><em>tar zxvf zextras_suite-latest.tgz</em></p><p></p><p></p><p><em>cd zextras_suite-[version]</em></p><p></p><p></p><p><em>./install.sh all</em></p><p></p><p></p><p><strong>2. Tạo một ổ cứng ảo mới để chứa dữ liệu backup và mount vào server với mount point là “/NewBackup”. Đảm bảo user zimbra có quyền sở hữu thư mục /NewBackup này.</strong></p><p></p><p></p><p>Kích thước của thư mục (ổ đĩa mới) /NewBackup này phải bằng tổng dung lượng hiện có của thư mục chứa dữ liệu mailstore và hsm (nếu bạn có dùng HSM module).</p><p></p><p></p><p>[Chạy với quyền root]</p><p></p><p></p><p><em>mkdir /NewBackup</em></p><p></p><p></p><p><em>chown zimbra:zimbra /NewBackup/</em></p><p></p><p></p><p><strong>3. Mount ổ đĩa mới vào mount point /NewBackup</strong></p><p></p><p></p><p>Ví dụ ổ cứng mới của bạn đã được format và có tên là /dev/hdb1</p><p></p><p></p><p>[Chạy với quyền root]</p><p></p><p></p><p><em>mount /dev/hdb1 /NewBackup</em></p><p></p><p></p><p><strong>4. Thay đổi đường dẫn thư mục backup tắt Realtime Scanner và redolog, sau đó khởi động lại mailbox service.</strong></p><p></p><p></p><p><em>su – zimbra</em></p><p></p><p></p><p><em>zxsuite backup setProperty ZxBackup_RealTimeScanner false</em></p><p></p><p></p><p><em>zxsuite backup setProperty ZxBackup_DestPath /NewBackup/</em></p><p></p><p></p><p><em>zmprov ms `zmhostname` zimbraRedoLogEnabled FALSE</em></p><p></p><p></p><p><em>zmmailboxdctl restart</em></p><p></p><p></p><p><strong>5. Chạy SmartScan và chờ cho đến khi hệ thống hoàn tất cả Realtime Scanning và SmartScan. Qúa trình này tốn thời gian để hoàn thành, phụ thuộc vào dung lượng hệ thống.</strong></p><p></p><p></p><p><em>zxsuite backup doSmartScan</em></p><p></p><p></p><p>Sau khi hoàn thành backup dữ liệu, hãy tắt dịch vụ Zimbra trên server cũ và mount ổ cứng backup vào server mới.</p><p></p><p></p><p><strong>Các bước thực hiện trên server mới</strong></p><p></p><p></p><p>Lưu ý: sau khi hệ thống mới được online, các kết nối hiện hữu đến hệ thống cũ sẽ mất. Người dùng phải kết nối lại vào hệ thống mới (bạn có thể thay đổi DNS để cập nhật địa chỉ IP của hệ thống mới) với username và mật khẩu đang dùng. Bạn phải tạo lại các profile ZCO.</p><p></p><p></p><p><strong>1. Cài đặt server mới với phiên bản 8.8.12. Không tạo bất kỳ account nào ngoài các account mặc định của hệ thống.</strong></p><p></p><p></p><p><strong>2. Khởi động SmartScan (sẽ hoàn thành trong vòng vài phút):</strong></p><p></p><p></p><p><em>su – zimbra</em></p><p></p><p></p><p><em>zxsuite backup doSmartScan</em></p><p></p><p></p><p><strong>3. Mount ổ cứng chứa dữ liệu backup của server cũ vào thư mục /NewBackupData. Đảm bảo rằng Zimbra user có quyền sở hữu thư mục này.</strong></p><p></p><p></p><p><strong>4. Tắt RealTime Scanning và Redolog.</strong></p><p></p><p></p><p><em>su – zimbra</em></p><p></p><p></p><p><em>zxsuite backup setProperty ZxBackup_RealTimeScanner false</em></p><p></p><p></p><p><em>zmprov ms `zmhostname` zimbraRedoLogEnabled FALSE</em></p><p></p><p></p><p><em>zmmailboxdctl restart</em></p><p></p><p></p><p><strong>5. Nếu bạn có lượng dữ liệu rất lớn cần migrate trong giai đoạn này, quá trình import có thể mất vài ngày, hãy theo cách sau đây để thực hiện.</strong></p><p></p><p></p><p>Thay vì import toàn bộ dữ liệu vào server mới, bạn chỉ chạy “Provisioning Only” nhằm tạo lại Domain, COS, account trên server mới và tạm hoãn việc import  nội dung dữ liệu mailbox.</p><p></p><p></p><p><em>zxsuite backup doExternalRestore /NewBackupData/ provisioning_only TRUE</em></p><p></p><p></p><p>Sau khi hoàn thành bước trên, bạn thay đổi hướng mail vào server mới (thực hiện cập nhật DNS, NAT trên firewall) và bắt đầu import dữ liệu mailbox thực sự:</p><p></p><p></p><p><em>zxsuite backup doExternalRestore /NewBackupData/</em></p><p></p><p></p><p>Theo cách này, người dùng có thể sử dụng server mới và dữ liệu cũ sẽ được import vào dần sau đó.</p><p></p><p></p><p><strong>6. Kiểm tra sau khi import</strong></p><p></p><p></p><p>Chạy các lệnh sau để kiểm tra và chỉnh lại các lỗi do thay đổi quyền chia sẻ nếu có.</p><p></p><p></p><p><em>zxsuite backup doCheckShares</em></p><p></p><p></p><p><em>zxsuite backup doFixShares</em></p><p></p><p></p><p><strong>7. Sau khi restore dữ liệu sử dụng External Restore, có khả năng cao là cơ chế chống trùng lặp sẽ không phát hiện được các message trùng lặp. Chạy lệnh sau để chỉnh sửa:</strong></p><p></p><p></p><p><em>zxsuite hsm getAllVolumes</em></p><p></p><p></p><p><em>zxsuite hsm doDeduplicate &lt;volume name of the store&gt;</em></p><p></p><p></p><p><strong>8. Xóa và tạo lại GAL sync account</strong></p><p></p><p></p><p><em>/opt/zimbra/bin/zmgsautil deleteAccount -a galsync@DOMAIN.COM</em></p><p></p><p></p><p><em>/opt/zimbra/bin/zmgsautil createAccount -a galsync@DOMAIN.COM -n InternalGAL –domain DOMAIN.COM -s &lt;zmhostname of mailbox server&gt; -t zimbra -f _InternalGAL</em></p><p></p><p></p><p><em>/opt/zimbra/bin/zmgsautil forceSync -a galsync@DOMAIN.COM -n InternalGAL</em></p><p></p><p></p><p>Thay domain.com bằng domain thực sự của bạn.</p><p></p><p></p><p><strong>9. Kiểm tra và xác nhận tất cả dịch vụ đã chạy, sau đó điều hướng luồng mail vào server mới.</strong></p><p></p><p></p><p><strong>10. Sau khi dữ liệu được phục hồi thì kích hoạt RealTime Scanner và khởi động lại mailbox service</strong></p><p></p><p></p><p><em>su – zimbra</em></p><p></p><p></p><p><em>zxsuite backup setProperty ZxBackup_RealTimeScanner true</em></p><p></p><p></p><p><em>zmmailboxdctl restart</em></p><p></p><p></p><p>Bạn có thể tham khảo hướng dẫn gốc của Zimbra tại <a href="https://wiki.zimbra.com/wiki/Steps_To_Rebuild_ZCS_Server">Zimbra WiKi</a></p><p></p></div><footer><div class="post__tags-share"><aside class="post__share"></aside></div><nav class="post__nav"><div class="post__nav__prev"><a class="post__nav__link" href="https://ddtrungit.github.io/upgrade-zimbra-86-to-88-centos/index.html" rel="prev">Previous Post<h3 class="h6">Upgrade zimbra 8.6 to 8.8 centos</h3></a></div><div class="post__nav__next"><a class="post__nav__link" href="https://ddtrungit.github.io/thiet-lap-canh-bao-qua-telegram/index.html" rel="prev">Next Post<h3 class="h6">Thiết lập cảnh báo qua telegram</h3></a></div></nav></footer></div></article><div class="comments-area post__inner" id="comments"><div class="comments"><div class="comments-wrapper"><h2>Comments</h2><div class="fb-comments" data-href="https://ddtrungit.github.io/cac-buoc-rebuild-zimbra-server-ng-backup/" data-width="100%" data-colorscheme="light" data-lazy="true" data-order-by="reverse_time" data-numposts="5"></div><noscript>Please enable JS to use the comments form.</noscript></div></div><div id="fb-root"></div><script type="text/javascript" async defer="defer" crossorigin="anonymous" src="https://connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v12.0">nonce="n4mWU9e7"</script></div></div><div class="post__related"><div class="wrapper"><h2 class="h5">Related posts</h2><div class="l-grid l-grid--4"><article class="c-card"><a href="https://ddtrungit.github.io/upgrade-zimbra-86-to-88-centos/index.html" class="c-card__image"><img src="https://ddtrungit.github.io/media/posts/79/tai-xuong.png" srcset="https://ddtrungit.github.io/media/posts/79/responsive/tai-xuong-xs.png 300w, https://ddtrungit.github.io/media/posts/79/responsive/tai-xuong-sm.png 480w, https://ddtrungit.github.io/media/posts/79/responsive/tai-xuong-md.png 768w, https://ddtrungit.github.io/media/posts/79/responsive/tai-xuong-lg.png 1200w" sizes="(min-width: 56.25em) 100vw, (min-width: 37.5em) 50vw, 100vw" loading="lazy" height="157" width="320" alt=""></a><div class="c-card__wrapper"><header class="c-card__header"><div class="c-card__tag"><a href="https://ddtrungit.github.io/tags/zimbra/index.html">Zimbra</a></div><h3 class="c-card__title"><a href="https://ddtrungit.github.io/upgrade-zimbra-86-to-88-centos/index.html" class="invert">Upgrade zimbra 8.6 to 8.8 centos</a></h3></header><p class="c-card__text">Trong trường hợp bạn muốn nâng cấp từ phiên bản thấp hơn (ví dụ như 8.6) lên 8.8, bạn cần&hellip;</p><footer class="c-card__meta"><div class="c-card__comments"><a href="https://ddtrungit.github.io/upgrade-zimbra-86-to-88-centos/index.html#comments" rel="nofollow" aria-label="Comments"><svg aria-hidden="true"><title>Comments</title><use xlink:href="https://ddtrungit.github.io/assets/svg/svg-map.svg#comments"/></svg></a></div></footer></div></article><article class="c-card"><a href="https://ddtrungit.github.io/csf-and-zimbra-mail/index.html" class="c-card__image"><img src="https://ddtrungit.github.io/media/posts/74/tai-xuong.png" srcset="https://ddtrungit.github.io/media/posts/74/responsive/tai-xuong-xs.png 300w, https://ddtrungit.github.io/media/posts/74/responsive/tai-xuong-sm.png 480w, https://ddtrungit.github.io/media/posts/74/responsive/tai-xuong-md.png 768w, https://ddtrungit.github.io/media/posts/74/responsive/tai-xuong-lg.png 1200w" sizes="(min-width: 56.25em) 100vw, (min-width: 37.5em) 50vw, 100vw" loading="lazy" height="157" width="320" alt=""></a><div class="c-card__wrapper"><header class="c-card__header"><div class="c-card__tag"><a href="https://ddtrungit.github.io/tags/zimbra/index.html">Zimbra</a></div><h3 class="c-card__title"><a href="https://ddtrungit.github.io/csf-and-zimbra-mail/index.html" class="invert">Csf and Zimbra mail</a></h3></header><p class="c-card__text">After that open the CSF configuration and enable the following ports, TCP_IN = "22,25,53,80,110,143,443,465,587,993,995,7071" TCP_OUT = "22,25,53,80,110,113,443,465,587,993,995,7071" Now you need&hellip;</p><footer class="c-card__meta"><div class="c-card__comments"><a href="https://ddtrungit.github.io/csf-and-zimbra-mail/index.html#comments" rel="nofollow" aria-label="Comments"><svg aria-hidden="true"><title>Comments</title><use xlink:href="https://ddtrungit.github.io/assets/svg/svg-map.svg#comments"/></svg></a></div></footer></div></article></div></div></div></main><footer class="footer"><div class="footer__social"><a href="https://facebook.com/duongtrung2103" aria-label="Facebook" class="facebook"><svg><use xlink:href="https://ddtrungit.github.io/assets/svg/svg-map.svg#facebook"/></svg></a></div><div class="footer__copyright">"DO THE THINGS YOU LOVE!"</div></footer><script>window.publiiThemeMenuConfig = {    
      mobileMenuMode: 'sidebar',
      animationSpeed: 300,
      submenuWidth: 'auto',
      doubleClickTime: 500,
      mobileMenuExpandableSubmenus: true, 
      relatedContainerForOverlayMenuSelector: '.navbar',
   };</script><script defer="defer" src="https://ddtrungit.github.io/assets/js/scripts.min.js?v=d78591855e0ce96bf51239b499260e20"></script><script>var images = document.querySelectorAll('img[loading]');

      for (var i = 0; i < images.length; i++) {
         if (images[i].complete) {
               images[i].classList.add('is-loaded');
         } else {
               images[i].addEventListener('load', function () {
                  this.classList.add('is-loaded');
               }, false);
         }
      }</script></body></html>