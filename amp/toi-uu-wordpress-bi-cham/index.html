<!doctype html><html amp lang="vi"><head><meta charset="utf-8"><title>TỐI ƯU WORDPRESS BỊ CHẬM - TRUNG DUONG</title><link rel="canonical" href="https://ddtrungit.github.io/toi-uu-wordpress-bi-cham/"><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"><link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet" type="text/css"><script async custom-element="amp-sidebar" src="https://cdn.ampproject.org/v0/amp-sidebar-0.1.js"></script><script async custom-element="amp-social-share" src="https://cdn.ampproject.org/v0/amp-social-share-0.1.js"></script><script async custom-element="amp-iframe" src="https://cdn.ampproject.org/v0/amp-iframe-0.1.js"></script><script async custom-element="amp-video" src="https://cdn.ampproject.org/v0/amp-video-0.1.js"></script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://ddtrungit.github.io/amp/toi-uu-wordpress-bi-cham/index.html"},"headline":"TỐI ƯU WORDPRESS BỊ CHẬM","datePublished":"2021-01-28T04:04","dateModified":"2022-06-13T14:30","image":{"@type":"ImageObject","url":"https://ddtrungit.github.io/media/posts/87/best-ways-to-speed-up-wp-site.jpg","height":1080,"width":1920},"description":"ừa rồi tôi được giao nhiệm vụ kiểm tra và tối ưu System cho blog WordPress của doanh nghiệp trong&hellip;","author":{"@type":"Person","name":"Duong Dinh Trung","url":"https://ddtrungit.github.io/amp/authors/dtrungit/"},"publisher":{"@type":"Organization","name":"Duong Dinh Trung","logo":{"@type":"ImageObject","url":"https://ddtrungit.github.io/media/website/Background_noBg.png","height":1200,"width":1600}}}</script><style amp-custom>article,
aside,
footer,
header,
hgroup,
main,
nav,
section {
  display: block; }

*,
*:before,
*:after {
  -webkit-box-sizing: content-box;
  box-sizing: content-box;
  margin: 0;
  padding: 0; }

li {
  list-style: none; }

amp-img {
  max-width: 100%; }

button,
input,
select,
textarea {
  font: inherit; }

html {
  font-size: 1rem; }

body {
  background: #f1f1f1;
  color: #262626;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
  line-height: 1.6; }

a {
  color:  #039be5;
  text-decoration: none;
  -webkit-transition: all 0.12s linear 0s;
  -o-transition: all 0.12s linear 0s;
  transition: all 0.12s linear 0s; }

a:hover {
  color: #262626;
  text-decoration: underline;
  -webkit-text-decoration-skip: ink;
  text-decoration-skip: ink; }

a:active {
  color: #262626; }

a:focus {
  outline: 2px dotted #039be5; }

figure,
blockquote,
p,
ul,
ol,
dl,
table,
hr,
fieldset {
  margin-top: 1.6rem; }

h1,
h2,
h3,
h4,
h5,
h6 {
  color: #262626;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
  font-weight: 500;
  line-height: 1.2;
  margin-top: 2.13333rem; }

h1 {
  font-size: 1.67583rem;
  font-weight: normal; }

h2 {
  font-size: 1.4729rem; }

h3 {
  font-size: 1.29454rem; }

h4 {
  font-size: 1.13778rem; }

h5 {
  font-size: 1rem; }

h6 {
  font-size: 0.87891rem; }

h2 + p,
h3 + p,
h4 + p,
h5 + p,
h6 + p {
  margin-top: 0.8rem; }

b,
strong {
  font-weight: 600; }

blockquote {
  color: #6c7175;
  font-family: "Droid Serif", "Times", "Source Serif Pro", serif;
  font-style: italic;
  padding: 1.33333rem 0.53333rem 1.33333rem 3.2rem;
  position: relative; }
  blockquote:before {
    display: block;
    content: "\201C";
    font-size: 4.41226rem;
    position: absolute;
    left: 0;
    top: -12px;
    color: rgba(108, 113, 117, 0.5); }
  blockquote > :nth-child(1) {
    margin-top: 0; }

ul,
ol {
  margin-left: 2rem; }
  ul > li,
  ol > li {
    list-style: inherit;
    padding: 0 0 0.26667rem 0.26667rem; }

dl dt {
  color: #262626;
  font-weight: 600; }

code,
pre {
  background-color: #f1f1f1;
  font-family: monospace; }

pre {
  margin: 1.6rem 0 0;
  padding: 1.6rem;
  white-space: pre-wrap;
  word-wrap: break-word;
  overflow-x: auto; }
  pre > code {
    color: #262626;
    padding: 0; }

code {
  border-radius: 3px;
  color: #262626;
  padding: 0.26667rem 0.53333rem; }

table {
  border-collapse: collapse;
  border-spacing: 0;
  border: 1px solid #d4d4d4;
  width: 100%;
  overflow-x: auto;
  vertical-align: top;
  text-align: left;
  white-space: nowrap; }
  table th {
    font-weight: 500;
    padding: 0.53333rem 1.06667rem; }
  table tr {
    border-bottom: 1px solid #d4d4d4; }
    table tr:nth-child(2n) {
      background: #f1f1f1; }
  table td {
    padding: 0.53333rem 1.06667rem; }

figcaption {
  clear: both;
  color: rgba(108, 113, 117, 0.6);
  font-size: 0.82397rem;
  margin: 0.8rem 0 0;
  text-align: center; }

sub,
sup {
  font-size: 65%; }

hr {
  border: 0;
  height: 0;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  border-bottom: 1px solid rgba(255, 255, 255, 0.3); }

.btn, [type=button],
[type=submit],
button {
  background: #039be5;
  border: none;
  border-radius: 2px;
  color: #ffffff;
  cursor: pointer;
  display: inline-block;
  font-size: 0.87891rem;
  font-weight: 500;
  line-height: 1.9;
  padding: 0.53333rem 1.33333rem;
  text-align: center;
  text-decoration: none;
  -webkit-transition: all .15s ease;
  -o-transition: all .15s ease;
  transition: all .15s ease;
  width: auto; }
  .btn:hover, [type=button]:hover,
  [type=submit]:hover,
  button:hover {
    background: #262626;
    color: #ffffff; }
  .btn:focus, [type=button]:focus,
  [type=submit]:focus,
  button:focus {
    outline: none; }
  .btn-outline {
    border: 1px solid #ddd;
    background: #ffffff;
    border-radius: 3px;
    color: #262626; }

[type=button],
[type=submit],
button {
  text-transform: uppercase;
  -webkit-appearance: none;
  -moz-appearance: none; }

.navbar {
  background: #039be5;
  -webkit-box-shadow: 0 0 6px 0 rgba(0, 0, 0, 0.2);
  box-shadow: 0 0 6px 0 rgba(0, 0, 0, 0.2);
  line-height: 3;
  max-height: 4rem; }
  .navbar > div {
    -webkit-box-align: center;
    -ms-flex-align: center;
    align-items: center;
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-pack: center;
    -ms-flex-pack: center;
    justify-content: center;
    text-align: left;
    max-width: 700px;
    margin: 0 auto; }
  .navbar a {
    color: #ffffff;
    text-decoration: none; }
  .navbar-sidebar-toggle {
    left: 0;
    position: relative;
    text-indent: -99999rem; }
    .navbar-sidebar-toggle:before {
      content: "";
      display: block;
      border-top: 0.375rem double #ffffff;
      border-bottom: 0.125rem solid #ffffff;
      height: 0.125rem;
      position: absolute;
      text-indent: 0;
      top: 50%;
      width: 1.3rem;
      -webkit-transform: translate(0px, -50%);
      -ms-transform: translate(0px, -50%);
      transform: translate(0px, -50%); }


.logo {
            background-image: url('https://ddtrungit.github.io/media/website/Background_noBg.png');
            background-size: auto 2rem;
            background-repeat: no-repeat;
            background-position: center center;
            display: inline-block;
  font-weight: 600;
  line-height: 1;
            margin: 0 auto;
            height: 2rem;
            text-indent: -9999px;
            width: 240px;vertical-align: middle;
        }
        .logo.logo-text {
            line-height: 2;
            text-align: center;
            text-indent: 0;
        }

amp-sidebar {
  background: #ffffff;
  width: 240px; }
  amp-sidebar > ul {
    margin: 0.8rem 0 0;
    padding: 0; }
    amp-sidebar > ul ul {
      border-left: 1px solid #d4d4d4;
      margin: 0.53333rem 0 0; }
    amp-sidebar > ul li {
      color: #262626;
      font-size: 0.9375rem;
      font-weight: 600;
      list-style: none;
      line-height: 1.4;
      padding: 0.42667rem 1.06667rem; }
      amp-sidebar > ul li li {
        font-weight: normal;
        padding: 0.26667rem 0 0.26667rem 1.06667rem; }
    amp-sidebar > ul a,
    amp-sidebar > ul a:visited {
      color: #262626; }

.bg-white {
  background: #ffffff; }

.wrap-page {
  max-width: 700px;
  margin: 0 auto; }

@media all and (max-width: 43.6875em) {
  .wrap-inner {
    padding: 0 6%; } }

.page-title {
  background: #ffffff;
  -webkit-box-shadow: 0 2px 3px rgba(38, 38, 38, 0.1);
  box-shadow: 0 2px 3px rgba(38, 38, 38, 0.1);
  margin-bottom: 0.8rem;
  padding: 1.6rem 6%; }
  .page-title > h1 {
    margin: 0;
    font-size: 1.29454rem; }
  .page-title > p {
    font-size: 0.87891rem;
    color: #6c7175;
    line-height: 1.3;
    margin: 0.26667rem 0 0; }
  .page-title-author {
    border-radius: 50%;
    float: left;
    height: 2.5rem;
    width: 2.5rem; }
    .page-title-author + h1 {
      margin-left: 3.5rem; }
      .page-title-author + h1 + p {
        margin-left: 3.5rem; }

.card {
  background: #ffffff;
  -webkit-box-shadow: 0 2px 3px rgba(38, 38, 38, 0.1);
  box-shadow: 0 2px 3px rgba(38, 38, 38, 0.1);
  margin-bottom: 0.8rem;
  padding-bottom: 1.06667rem; }

  .card-meta {
    border-top: 1px solid #d4d4d4;
    color: rgba(108, 113, 117, 0.6);
    font-size: 0.7242rem;
    font-weight: 500;
    margin-top: 1.06667rem;
    padding-top: 1.06667rem;
    text-transform: uppercase; }
    .card-meta a + time:before {
      content: "";
      background: #d4d4d4;
      display: inline-block;
      height: 3px;
      margin: 0 8px;
      width: 3px;
      vertical-align: middle;
      border-radius: 50%; }
  .card-text {
    font-size: 0.9375rem;
    overflow: hidden;
    padding: 0 6%; }
    .card-text h2 {
      font-size: 1.13778rem; }

.post {
  margin-bottom: 2.13333rem; }
  .post-featured-image {
    margin-top: 0;
    position: relative; }
    .post-featured-image > figcaption {
      background: rgba(0, 0, 0, 0.5);
      border-radius: 3px;
      color: #ffffff;
      position: absolute;
      bottom: 0.8rem;
      padding: 0 0.26667rem;
      right: 6%; }
  .post-header {
    margin-bottom: 2.13333rem; }
  .post-meta {
    border-bottom: 1px solid #d4d4d4;
    color: rgba(108, 113, 117, 0.6);
    font-size: 0.7242rem;
    font-weight: 500;
    margin-top: 1.06667rem;
    padding-bottom: 1.06667rem;
    text-transform: uppercase; }
    .post-meta a + time:before {
      content: "";
      background: #d4d4d4;
      display: inline-block;
      height: 3px;
      margin: 0 8px;
      width: 3px;
      vertical-align: middle;
      border-radius: 50%; }
  .post-tag {
    margin: 0; }
    .post-tag > li {
      display: inline-block;
      padding: 0; }
      .post-tag > li a {
        background: #f1f1f1;
        border-radius: 2px;
        color: #6c7175;
        font-size: 0.77248rem;
        display: inline-block;
        margin: 0 0.26667rem 0.26667rem 0;
        padding: 0.26667rem 0.53333rem; }
        .post-tag > li a:hover {
          background: #039be5;
          color: #ffffff;
          text-decoration: none; }
  .post-share {
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-orient: horizontal;
    -webkit-box-direction: normal;
    -ms-flex-direction: row;
    flex-direction: row;
    -webkit-box-pack: justify;
    -ms-flex-pack: justify;
    justify-content: space-between;
    margin-top: 1.6rem;
    width: 100%; }
    .post-share amp-social-share {
      -webkit-box-flex: 1;
      -ms-flex: 1 0 auto;
      flex: 1 0 auto;
      background-size: 24px; }
  .post-scroll {
    color: #ffffff;
    background: #039be5;
    bottom: 10px;
    border-radius: 50%;
    border: none;
    -webkit-box-shadow: 0 1px 1.5px 0 rgba(38, 38, 38, 0.12), 0 1px 1px 0 rgba(38, 38, 38, 0.24);
    box-shadow: 0 1px 1.5px 0 rgba(38, 38, 38, 0.12), 0 1px 1px 0 rgba(38, 38, 38, 0.24);
    font-size: 1.13778rem;
    height: 46px;
    opacity: 0;
    outline: none;
    position: fixed;
    padding: 0;
    right: 4%;
    visibility: hidden;
    width: 46px;
    z-index: 9999; }
    .post-scroll-marker {
      height: 0px;
      position: absolute;
      top: 100px;
      width: 0px; }
        .post-pagination {
    background: #f1f1f1;
    -webkit-box-shadow: inset 0 2px 3px rgba(38, 38, 38, 0.1);
    box-shadow: inset 0 2px 3px rgba(38, 38, 38, 0.1);
    border-top: 1px solid #d4d4d4;
    padding: 1.06667rem 0; }
    .post-pagination > div {
      line-height: 1.2;
      padding: 0.53333rem 1.06667rem;
      text-align: center; }
      .post-pagination > div span {
        display: block;
        color: #6c7175;
        font-size: 0.7242rem;
        font-weight: 500;
        margin-bottom: 0.26667rem;
        text-transform: uppercase; }
    .post-pagination-prev a:before {
      content: "\2190";
      margin-right: 0.26667rem; }
    .post-pagination-next a:after {
      content: "\2192";
      margin-left: 0.26667rem; }

aside {
  margin: 1.6rem 0 0; }

.align-left {
  text-align: left; }

.align-right {
  text-align: right; }

.align-center {
  text-align: center; }

.align-justify {
  text-align: justify; }

.msg {
  border-left: 2px solid transparent;
  padding: 1.06667rem 1.06667rem; }
  .msg--highlight {
    background-color: #fff8e6;
    border-color: #e2ac4f; }
  .msg--info {
    background: rgba(45, 97, 201, 0.03);
    border-color: #039be5; }
  .msg--success {
    background: #f7fbf6;
    border-color: #5ab44b; }
  .msg--warning {
    background: #fff3f3;
    border-color: #c06367;
    color: #a94442; }

.dropcap:first-letter {
  float: left;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
  font-size: 2.16943rem;
  line-height: 0.7;
  margin-right: 0.53333rem;
  padding: 0.53333rem 0.53333rem 0.53333rem 0; }

.pagination {
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-pack: justify;
  -ms-flex-pack: justify;
  justify-content: space-between;
  margin: 0.8rem 0; }
  .pagination > a {
    padding-left: 0;
    padding-right: 0;
    width: 49%; }
  .pagination-right {
    margin-left: auto; }

.bottom {
  background: #039be5;
  color: #ffffff;
  padding: 1.06667rem 4%;
  text-align: center; }</style><style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript><script async src="https://cdn.ampproject.org/v0.js"></script><script custom-element="amp-animation" src="https://cdn.ampproject.org/v0/amp-animation-0.1.js" async></script><script custom-element="amp-position-observer" src="https://cdn.ampproject.org/v0/amp-position-observer-0.1.js" async></script></head><body class="bg-white"><nav class="navbar wrap-inner" id="top"><div><a on="tap:navbar-sidebar.toggle" class="navbar-sidebar-toggle" title="Menu">Menu</a> <a class="logo" href="https://ddtrungit.github.io/amp/index.html">TRUNG DUONG</a></div></nav><main class="wrap-page"><article class="post"><figure class="post-featured-image"><amp-img src="https://ddtrungit.github.io/media/posts/87/best-ways-to-speed-up-wp-site.jpg" alt="" srcset="https://ddtrungit.github.io/media/posts/87/responsive/best-ways-to-speed-up-wp-site-xs.jpg 300w ,https://ddtrungit.github.io/media/posts/87/responsive/best-ways-to-speed-up-wp-site-sm.jpg 480w ,https://ddtrungit.github.io/media/posts/87/responsive/best-ways-to-speed-up-wp-site-md.jpg 768w ,https://ddtrungit.github.io/media/posts/87/responsive/best-ways-to-speed-up-wp-site-lg.jpg 1200w" sizes="(min-width: 56.25em) 100vw, (min-width: 37.5em) 50vw, 100vw" height="1080" layout="responsive" width="1920"></amp-img></figure><div class="wrap-inner"><header class="post-header"><h1>TỐI ƯU WORDPRESS BỊ CHẬM</h1><p class="post-meta">By <a href="https://ddtrungit.github.io/amp/authors/dtrungit/index.html" rel="nofollow" title="Duong Dinh Trung">Duong Dinh Trung</a></p></header><p></p><p>ừa rồi tôi được giao nhiệm vụ kiểm tra và tối ưu System cho blog WordPress của doanh nghiệp trong lĩnh vực Internet ở Việt Nam với lượng truy cập tương đối lớn. Website gặp tình trạng thường bị load chậm hoặc quá tải khi chạy các chiến dịch marketing. Dù cho khách hàng có đội dev riêng rất giỏi, đã tối ưu rất tốt từ mặt coding đến database, caching</p><p></p><p></p><p>OK, Challenge Accepted, bắt tay vào việc thôi!</p><p></p><p></p><figure class="wp-block-image"><figure class="wp-image-431"><amp-img src="https://ddtrungit.github.io/media/posts/87/challenge_accepted-1024x739.jpeg" sizes="(max-width: 48em) 100vw, 100vw" srcset="https://ddtrungit.github.io/media/posts/87/responsive/challenge_accepted-1024x739-xs.jpeg 300w ,https://ddtrungit.github.io/media/posts/87/responsive/challenge_accepted-1024x739-sm.jpeg 480w ,https://ddtrungit.github.io/media/posts/87/responsive/challenge_accepted-1024x739-md.jpeg 768w" alt="" layout="responsive"></amp-img></figure></figure><p></p><p></p><h2>KIỂM TRA SƠ BỘ TRƯỚC KHI TỐI ƯU WORDPRESS</h2><p></p><p></p><p>Trước tiên, cần đo lường thời gian xử lý trang index.php trước đã. Lưu lại để làm xong còn đối chiếu xem mình tối ưu wordpress có hiệu quả hay không. Áp dụng phương pháp tương tự đã trình bày trong bài: <a href="https://blog.vietnix.vn/toi-da-toi-uu-wordpress-nhanh-hon-18-lan-nhu-the-nao.html">“Tôi đã tối ưu WordPress nhanh hơn 18 lần như thế nào”</a>, tôi check xử lý PHP trực tiếp không đi qua Web Server bằng lệnh:</p><p></p><p></p><pre class="wp-block-code"><code>$ time php index.php</code></pre><p></p><p></p><p>Thời gian xử lý dao động vào khoảng 30s-40s. Quá chậm, như này mà không xử lý được thì toang thật.</p><p></p><p></p><p>Kiểm tra tài nguyên server:</p><p></p><p></p><ul><li>RAM: còn dư nhiều.</li><li>Load Average: Load cao hơn số core của VPS hiện có =&gt; đang bị quá tải (thiếu CPU)</li><li>IO ổ cứng thì ổn, đạt chuẩn tốc độ SSD.</li><li>VPS chạy mô hình <a href="https://blog.vietnix.vn/zero2hero-4-gioi-thieu-ve-lamp-lemp-reverse-proxy-mo-hinh-he-thong-web.html">Reverse Proxy</a>, trong đó sử dụng Apache chạy mod_php để xử lý PHP. Lệnh “top” cho thấy process httpd thường xuyên chiếm 100% CPU.</li><li>Kết quả thống kê CPU của lệnh top cho thấy CPU được phân bổ vào %us (user) và %sy (system) =&gt; Có thể loại bỏ nguyên nhân chậm do IO (vì %iowait không cao) và các vấn đề khác liên quan interrupt (do %si thấp).</li></ul><p></p><p></p><h2>TỔNG QUAN</h2><p></p><p></p><p>Sau 30s làm quen, nắm tình hình tổng quan hệ thống cần tối ưu wordpress của khách hàng như sau:</p><p></p><p></p><ul><li>Hệ thống đang bị qúa tải CPU, chủ yếu là ở phần xử lý ở user space và các system call của hệ thống. Nhiệm vụ ta cần phải phân tích và tìm cách tối ưu chỗ này.</li><li>Hệ thống sử dụng mod_php (Apache2Handler), mỗi request đến file PHP sẽ được handle bởi 1 process httpd. Trường hợp nếu chạy chiến dịch marketing, traffic đổ về nhiều và <strong>CÙNG LÚC </strong>thì sẽ có nhiều process httpd được sinh ra =&gt; dẫn đến tình trạng hết RAM =&gt; server xử lý chậm =&gt; task dồn vào queue nhiều =&gt; load cao, delay cao.</li><li>Process httpd khi handle request của người dùng cắn 100% CPU và thời gian xử lý khá lâu. Đây có lẽ là nút thắt quan trọng nhất cần phải gỡ. Vì khi httpd handle request người dùng nhanh sẽ giúp hạn chế số lượng process httpd được sinh ra. Điều này giúp giảm lượng RAM, CPU sử dụng và giảm delay của người dùng. </li></ul><p></p><p></p><p>Như đã phân tích ở trên, nhiệm vụ của httpd hiện tại là load mod_php lên và xử lý các file PHP. Suy cho cùng cái chúng ta cần tập trung ở đây là xem xét cách server xử lý các file PHP như thế nào.</p><p></p><p></p><h2>PHÂN TÍCH CÁCH SERVER XỬ LÝ PHP</h2><p></p><p></p><p>Sau khi khoanh vùng, tôi tiến hành xem chi tiết cách hệ thống đang xử lý 1 file PHP. Kiểm tra mặt system call trước, chạy strace để thống kê sơ bộ khi xử lý 1 file PHP thì các system call được gọi như thế nào:</p><p></p><p></p><pre class="wp-block-code"><code>$ strace -c php index.php</code></pre><p></p><p></p><figure class="wp-block-image"><figure class="wp-image-432"><amp-img src="https://ddtrungit.github.io/media/posts/87/hr_1.png" sizes="(max-width: 48em) 100vw, 100vw" srcset="https://ddtrungit.github.io/media/posts/87/responsive/hr_1-xs.png 300w ,https://ddtrungit.github.io/media/posts/87/responsive/hr_1-sm.png 480w ,https://ddtrungit.github.io/media/posts/87/responsive/hr_1-md.png 768w" alt="" layout="responsive"></amp-img></figure></figure><p></p><p></p><p>Kết quả khá rõ ràng, system call gettimeofday được gọi đến 1,3 triệu lần và chiếm 96,96%. Đây rõ ràng là điểm quá bất thường. Vậy gettimeofday là gì, vì sao lại được gọi nhiều đến thế? Theo man page của Linux thì gettimeofday sẽ trả về: “number of seconds and microseconds since the Epoch”</p><p></p><p></p><p>Vậy system call này liên quan đến việc lấy thời gian hiện tại, số lần system call này được gọi rất lớn, đến 1,3tr lần … lẽ nào là do thằng W3 Total cache không nhỉ? Có lẽ nào W3 Total Cache gọi hàm này để check xem các file cache có hết hạn hay chưa để update file mới, site to thế này nên việc có nhiều file cache sẽ khiến system call này được gọi nhiều lần, hợp lý quá mà.</p><p></p><p></p><p>Nhảy ngay vào source code grep “gettimeofday” xác nhận lại xem sao. Kết qủa trả về chỉ có plugins “w3total_cache” sử dụng hàm này.</p><p></p><p></p><figure class="wp-block-image"><figure class="wp-image-433"><amp-img src="https://ddtrungit.github.io/media/posts/87/hr_2.png" sizes="(max-width: 48em) 100vw, 100vw" srcset="https://ddtrungit.github.io/media/posts/87/responsive/hr_2-xs.png 300w ,https://ddtrungit.github.io/media/posts/87/responsive/hr_2-sm.png 480w ,https://ddtrungit.github.io/media/posts/87/responsive/hr_2-md.png 768w" alt="" layout="responsive"></amp-img></figure></figure><p></p><p></p><p>Hàm <em>gettimeofday()</em> được gọi trong hàm <em>getmicrotime()</em>. Và hàm <em>getmicrotime()</em> được gọi trong hàm <strong><em>debug()</em></strong></p><p></p><p></p><figure class="wp-block-image"><figure class="wp-image-434"><amp-img src="https://ddtrungit.github.io/media/posts/87/hr_3.png" sizes="(max-width: 48em) 100vw, 100vw" srcset="https://ddtrungit.github.io/media/posts/87/responsive/hr_3-xs.png 300w ,https://ddtrungit.github.io/media/posts/87/responsive/hr_3-sm.png 480w ,https://ddtrungit.github.io/media/posts/87/responsive/hr_3-md.png 768w" alt="" layout="responsive"></amp-img></figure></figure><p></p><p></p><p>Nếu debug Level &gt; 0 thì hàm <em>getmicrotime()</em> sẽ được gọi, và qua đó <em>gettimeofday()</em> sẽ được gọi. Quá rõ ràng, game hôm nay dễ thế, end game thôi. Vào wp-admin tắt debug của w3total cache là xong!</p><p></p><p></p><h2>KẾT QUẢ BẤT NGỜ</h2><p></p><p></p><p>Những tưởng quá trình tối ưu WordPress hôm nay đến đây là kết thúc. Tuy nhiên khi báo khách hàng vào tắt debug của W3 Total Cache, tôi thử lại và kết quả vẫn như cũ. Tại sao lại như vậy nhỉ? Nghi ngờ khách hàng tắt chưa đúng, tôi xin account admin vào để tự tay mình tắt cho chắc chắn rồi thử lại. Kết quả vẫn như cũ: system call gettimeofday vẫn được gọi 1,3tr lần khi xử lý PHP, performance không được cải thiện và delay vẫn như cũ. Điên máu, tôi move luôn thư mục w3total cache ra khỏi plugins để tạm thời disable nó. Kết quả vẫn không thay đổi! Tại sao? </p><p></p><p></p><p>Tôi chợt nhận ra, có vẻ mình đã bị lừa, hàm <em>gettimeofday()</em> trong plugin W3 Total Cache của PHP chưa chắc đã gọi system call gettimeofday của kernel. Tôi đã quá vội vàng và xử lý theo suy nghĩ cảm tính của mình trong khi chưa xem xét kỹ các bằng chứng kỹ thuật khác. Quay lại strace process PHP và xem xét kỹ kết quả, tôi chợt nhận ra:</p><p></p><p></p><pre class="wp-block-code"><code>$ strace -o output.txt php index.php</code></pre><p></p><p></p><figure class="wp-block-image"><figure class="wp-image-435"><amp-img src="https://ddtrungit.github.io/media/posts/87/hr_6-1024x710.png" sizes="(max-width: 48em) 100vw, 100vw" srcset="https://ddtrungit.github.io/media/posts/87/responsive/hr_6-1024x710-xs.png 300w ,https://ddtrungit.github.io/media/posts/87/responsive/hr_6-1024x710-sm.png 480w ,https://ddtrungit.github.io/media/posts/87/responsive/hr_6-1024x710-md.png 768w" alt="" layout="responsive"></amp-img></figure></figure><p></p><p></p><p>gettimeofday được gọi mỗi khi chuẩn bị mở file mới hoặc cấp phát một vùng nhớ mới cho process (system call open và brk). Đặc điểm này giống hệt với cách ghi debug log, kiên nhẫn xem kỹ hơn tôi thấy sự xuất hiện của một nhân tố mới: NewRelic.</p><p></p><p></p><h2>NEWRELIC</h2><p></p><p></p><p>NewRelic là một APM (Application Performance Monitoring), trong thường hợp hiện tại, NewRelic sẽ thọc sâu vào xử lý của PHP và đưa ra các chỉ số đo lường để chúng ta đánh giá, theo dõi ứng dụng PHP như: sự liên kết giữa các file, thời gian xử lý từng file … vậy nên việc gọi gettimeofday sẽ đóng vai trò quan trọng trong việc NewRelic gửi metrics về monitor server, vì các giải pháp monitoring sẽ dụng Timeseries Database với metric có dạng: “(time, key =&gt; value)”, trong đó time thường là dạng seconds since epoch, rất liên quan tới gettimeofday. Đây cũng là 1 điểm đáng phải cân nhắc!</p><p></p><p></p><p>Lần theo dấu vết của NewRelic, tôi phát hiện thêm điểm nghi vấn khác: Xdebug. Điểm này rất đáng để xem xét, vì theo những thông tin thu thập được, tôi khá chắc chắn rằng gettimeofday có liên quan mật thiết đến tính năng debug nào đó.</p><p></p><p></p><h2>XDEBUG</h2><p></p><p></p><p>Tìm thêm thông tin về Xdebug:</p><p></p><p></p><figure class="wp-block-image"><figure class="wp-image-436"><amp-img src="https://ddtrungit.github.io/media/posts/87/hr_10.png" sizes="(max-width: 48em) 100vw, 100vw" srcset="https://ddtrungit.github.io/media/posts/87/responsive/hr_10-xs.png 300w ,https://ddtrungit.github.io/media/posts/87/responsive/hr_10-sm.png 480w ,https://ddtrungit.github.io/media/posts/87/responsive/hr_10-md.png 768w" alt="" layout="responsive"></amp-img></figure></figure><p></p><p></p><p>Xdebug sẽ “record” tất cả function call và variable assignment. Nghe có vẻ đúng như thứ ta đang tìm kiếm rồi. Tiếp tục tìm thêm thông tin:</p><p></p><p></p><figure class="wp-block-image"><figure class="wp-image-437"><amp-img src="https://ddtrungit.github.io/media/posts/87/hr_7.png" sizes="(max-width: 48em) 100vw, 100vw" srcset="https://ddtrungit.github.io/media/posts/87/responsive/hr_7-xs.png 300w ,https://ddtrungit.github.io/media/posts/87/responsive/hr_7-sm.png 480w ,https://ddtrungit.github.io/media/posts/87/responsive/hr_7-md.png 768w" alt="" layout="responsive"></amp-img></figure></figure><p></p><p></p><p>Khá nhiều report liên quan đến việc Xdebug làm giảm performance cũng như liên quan đến việc gettimeofday được gọi quá nhiều lần. Tôi đã nhìn thấy hình ảnh hệ thống hiện tại trong đấy rồi :)). Tắt extension này và thử lại:</p><p></p><p></p><figure class="wp-block-image"><figure class="wp-image-438"><amp-img src="https://ddtrungit.github.io/media/posts/87/hr_4.png" sizes="(max-width: 48em) 100vw, 100vw" srcset="https://ddtrungit.github.io/media/posts/87/responsive/hr_4-xs.png 300w ,https://ddtrungit.github.io/media/posts/87/responsive/hr_4-sm.png 480w ,https://ddtrungit.github.io/media/posts/87/responsive/hr_4-md.png 768w" alt="" layout="responsive"></amp-img></figure></figure><p></p><p></p><p>Bingo! gettimeofday hoàn toàn biến mất khỏi top 1. CPU usage khi xử lý PHP cũng giảm xuống đáng kể . Thời gian xử lý đã rút ngắn xuống chỉ còn vài giây.</p><p></p><p></p><h2>CHƯA ĐƯỢC PHÉP DỪNG LẠI</h2><p></p><p></p><p>Nút thắt quan trọng nhất trong nhiệm vụ tối ưu wordpress đã được gỡ. Tôi thở phào nhẹ nhõm và chuẩn bị tinh thần để thông báo tin vui đến khách. Tuy nhiên, kết quả trên vẫn chưa cho phép tôi dừng lại khi thấy strace thống kê “lstat”, “open” và “fstat” là những system call top đầu được gọi. Vì điều này cho thấy việc truy cập file của hệ thống chưa được tối ưu. Tình huống lúc này tương tự như bài <a href="https://blog.vietnix.vn/toi-da-toi-uu-wordpress-nhanh-hon-18-lan-nhu-the-nao.html">“Tôi đã tối ưu WordPress nhanh hơn 18 lần như thế nào”</a></p><p></p><p></p><p>Kiểm tra nhanh thì thấy hệ thống đang sử dụng PHP 5.6 và chưa được triển khai Opcache. Tôi tiến hành nâng cấp lên PHP 7.2 kèm theo Opcache cho họ. Kết quả</p><p></p><p></p><figure class="wp-block-image"><figure class="wp-image-439"><amp-img src="https://ddtrungit.github.io/media/posts/87/hr_8.png" sizes="(max-width: 48em) 100vw, 100vw" srcset="https://ddtrungit.github.io/media/posts/87/responsive/hr_8-xs.png 300w ,https://ddtrungit.github.io/media/posts/87/responsive/hr_8-sm.png 480w ,https://ddtrungit.github.io/media/posts/87/responsive/hr_8-md.png 768w" alt="" layout="responsive"></amp-img></figure></figure><p></p><p></p><p>Đến đây. thời gian xử lý site chỉ còn lại vỏn vẹn 0.5s. Tôi nghĩ mình có thể dừng lại tại đây được rồi!</p><p></p><p></p><p>Sau 1 hồi hì hục thì kết quả đạt được:</p><p></p><p></p><ul><li>Giảm thời gian xử lý từ 40s xuống 0.5s</li><li>Giảm được “1,351,675” lệnh thừa khi xử lý PHP.</li><li>Hệ thống đã ổn định và tin cậy, tự tin phục vụ cho các chiến dịch marketing.</li></ul><p></p><p></p><figure class="wp-block-image"><figure class="wp-image-440"><amp-img src="https://ddtrungit.github.io/media/posts/87/hr_5.png" sizes="(max-width: 48em) 100vw, 100vw" srcset="https://ddtrungit.github.io/media/posts/87/responsive/hr_5-xs.png 300w ,https://ddtrungit.github.io/media/posts/87/responsive/hr_5-sm.png 480w ,https://ddtrungit.github.io/media/posts/87/responsive/hr_5-md.png 768w" alt="" layout="responsive"></amp-img></figure></figure><p></p><p></p><h2>BÀI HỌC RÚT RA KHI TỐI ƯU WORDPRESS</h2><p></p><p></p><ol><li>Khi hệ thống có vấn đề, điều quan trọng nhất là cùng nhìn về mục tiêu chung: giải quyết được vấn đề đang gặp. Hãy cố gắng hết sức trong khả năng của mình thay vì mang suy nghĩ: site chậm là do bên code, báo dev xem lại code. Nếu suy nghĩ đó xảy ra trong tình huống này, tôi khá chắc chắn là vấn đề sẽ không bao giờ được giải quyết triệt để, thay vào đó sẽ nghĩ đến phương án nâng cấp thêm CPU cho server hoặc triển khai giải pháp load balancing để phân tải.</li><li>Kinh nghiệm, phán đoán là tốt, nhưng cần phải kết hợp với các bằng chứng kỹ thuật được thể hiện trên hệ thống. Đừng để kinh nghiệm đánh lừa mình, hãy nhìn vào bản chất sự việc và tìm hiểu xem việc gì đang xảy ra, mọi thứ đang diễn ra như thế nào.</li></ol><p></p><aside><ul class="post-tag"><li><a href="https://ddtrungit.github.io/amp/tags/tip/index.html">Tip</a></li></ul><div class="post-share"><amp-social-share type="system" width="40" height="40" data-param-text="TỐI ƯU WORDPRESS BỊ CHẬM"></amp-social-share><amp-social-share type="facebook" width="40" height="40" data-param-app_id="" data-param-text="TỐI ƯU WORDPRESS BỊ CHẬM" data-param-href="https://ddtrungit.github.io/amp/toi-uu-wordpress-bi-cham/index.html"></amp-social-share><amp-social-share type="twitter" width="40" height="40" data-param-text="TỐI ƯU WORDPRESS BỊ CHẬM" data-param-url="https://ddtrungit.github.io/amp/toi-uu-wordpress-bi-cham/index.html"></amp-social-share><amp-social-share type="pinterest" width="40" height="40" data-param-url="https://ddtrungit.github.io/amp/toi-uu-wordpress-bi-cham/index.html"></amp-social-share><amp-social-share type="tumblr" width="40" height="40" data-param-text="TỐI ƯU WORDPRESS BỊ CHẬM" data-param-url="https://ddtrungit.github.io/amp/toi-uu-wordpress-bi-cham/index.html"></amp-social-share><amp-social-share type="whatsapp" width="40" height="40" data-param-text="TỐI ƯU WORDPRESS BỊ CHẬM" data-param-url="https://ddtrungit.github.io/amp/toi-uu-wordpress-bi-cham/index.html"></amp-social-share></div></aside></div></article></main><amp-animation id="showAnim" layout="nodisplay"><script type="application/json">{
                    "duration": "200ms",
                    "fill": "both",
                    "iterations": "1",
                    "direction": "alternate",
                    "animations": [{
                        "selector": ".post-scroll",
                        "keyframes": [{
                            "opacity": "1",
                            "visibility": "visible",
                            "transform": "scale(1)"
                        }]
                    }]
                }</script></amp-animation><amp-animation id="hideAnim" layout="nodisplay"><script type="application/json">{
                    "duration": "200ms",
                    "fill": "both",
                    "iterations": "1",
                    "direction": "alternate",
                    "animations": [{
                        "selector": ".post-scroll",
                        "keyframes": [{
                            "opacity": "0",
                            "visibility": "hidden",
                            "transform": "scale(0.1)"
                        }]
                    }]
                }</script></amp-animation><div class="post-scroll-marker"><amp-position-observer on="enter:hideAnim.start; exit:showAnim.start" layout="nodisplay"></amp-position-observer></div><button class="post-scroll" on="tap:top.scrollTo(duration=200)">&#8593;</button><footer class="bottom">Powered by Publii</footer><amp-sidebar id="navbar-sidebar" layout="nodisplay"><ul><li><a href="https://ddtrungit.github.io/amp/index.html">Home</a></li><li><a href="https://ddtrungit.github.io/amp/lien-he/index.html">Contact</a></li><li><a href="https://ddtrungit.github.io/amp/gioi-thieu/index.html">About</a></li><li><a href="https://ddtrungit.github.io/amp/tags/ansible/index.html">Ansible</a></li><li><a href="https://ddtrungit.github.io/amp/tags/aws/index.html">AWS</a></li><li><a href="https://ddtrungit.github.io/amp/tags/oracle/index.html">Oracle</a></li><li><a href="https://ddtrungit.github.io/amp/tags/linux/index.html">Linux</a></li><li><a href="https://ddtrungit.github.io/amp/tags/zimbra/index.html">Zimbra</a></li><li><a href="https://ddtrungit.github.io/amp/tags/tip/index.html">TIP</a></li></ul></amp-sidebar></body></html>